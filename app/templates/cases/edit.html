{% extends "base.html" %}

{% block title %}Edit Case - {{ case.case_name }} - LITE{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="fas fa-edit me-2"></i>Edit Case: {{ case.case_name }}
                </h4>
                <small class="text-muted">Case ID: {{ case.case_uuid }}</small>
            </div>
            <div class="card-body">
                <form method="POST" id="editCaseForm">
                    <!-- Case Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="case_name" class="form-label">Case Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="case_name" name="case_name" 
                                   value="{{ case.case_name }}" placeholder="Enter case name" required>
                            <div class="form-text">A unique identifier for this investigation case</div>
                        </div>
                        <div class="col-md-6">
                            <label for="case_priority" class="form-label">Priority</label>
                            <select class="form-select" id="case_priority" name="case_priority">
                                <option value="low" {{ 'selected' if case.case_priority == 'low' else '' }}>Low</option>
                                <option value="medium" {{ 'selected' if case.case_priority == 'medium' else '' }}>Medium</option>
                                <option value="high" {{ 'selected' if case.case_priority == 'high' else '' }}>High</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="active" {{ 'selected' if case.status == 'active' else '' }}>Active</option>
                                <option value="inactive" {{ 'selected' if case.status == 'inactive' else '' }}>Inactive</option>
                                <option value="closed" {{ 'selected' if case.status == 'closed' else '' }}>Closed</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="collection_date" class="form-label">Collection Date</label>
                            <input type="datetime-local" class="form-control" id="collection_date" name="collection_date"
                                   value="{{ case.collection_date.strftime('%Y-%m-%dT%H:%M') if case.collection_date else '' }}">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="case_description" class="form-label">Case Description</label>
                        <textarea class="form-control" id="case_description" name="case_description" 
                                  rows="3" placeholder="Describe the investigation case...">{{ case.case_description or '' }}</textarea>
                        <div class="form-text">Provide details about the investigation objectives and scope</div>
                    </div>
                    
                    <!-- Investigator Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="investigator_name" class="form-label">Lead Investigator</label>
                            <input type="text" class="form-control" id="investigator_name" name="investigator_name" 
                                   value="{{ case.investigator_name or '' }}" placeholder="Enter investigator name">
                        </div>
                        <div class="col-md-6">
                            <label for="investigator_email" class="form-label">Investigator Email</label>
                            <input type="email" class="form-control" id="investigator_email" name="investigator_email" 
                                   value="{{ case.investigator_email or '' }}" placeholder="investigator@example.com">
                        </div>
                    </div>
                    
                    <!-- Evidence Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="evidence_source" class="form-label">Evidence Source</label>
                            <input type="text" class="form-control" id="evidence_source" name="evidence_source" 
                                   value="{{ case.evidence_source or '' }}" placeholder="e.g., Server hostname, workstation ID">
                            <div class="form-text">Source system or device where evidence was collected</div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="evidence_notes" class="form-label">Evidence Notes</label>
                        <textarea class="form-control" id="evidence_notes" name="evidence_notes" 
                                  rows="3" placeholder="Additional notes about evidence collection...">{{ case.evidence_notes or '' }}</textarea>
                    </div>
                    
                    <!-- Case Metadata (Read-only) -->
                    <div class="card bg-light mb-4">
                        <div class="card-header bg-transparent">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i>Case Metadata (Read-only)
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-5">Case UUID:</dt>
                                        <dd class="col-sm-7"><code>{{ case.case_uuid }}</code></dd>
                                        
                                        <dt class="col-sm-5">Schema Name:</dt>
                                        <dd class="col-sm-7"><code>{{ case.schema_name }}</code></dd>
                                        
                                        <dt class="col-sm-5">Created:</dt>
                                        <dd class="col-sm-7">{{ case.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</dd>
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <dl class="row">
                                        <dt class="col-sm-5">Last Updated:</dt>
                                        <dd class="col-sm-7">{{ case.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</dd>
                                        
                                        <dt class="col-sm-5">Total Files:</dt>
                                        <dd class="col-sm-7">{{ stats.total_files if stats else 0 }}</dd>
                                        
                                        <dt class="col-sm-5">Data Size:</dt>
                                        <dd class="col-sm-7">{{ stats.total_data_size_mb if stats else 0 }}MB</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('cases.view_case', case_id=case.case_uuid) }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Cancel
                        </a>
                        <div>
                            <button type="button" class="btn btn-outline-danger me-2" onclick="confirmDelete()">
                                <i class="fas fa-trash me-1"></i>Delete Case
                            </button>
                            <button type="submit" class="btn btn-primary" id="saveBtn">
                                <i class="fas fa-save me-1"></i>Save Changes
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this case?</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone. All case data, including:
                    <ul class="mb-0 mt-2">
                        <li>Case information and metadata</li>
                        <li>All uploaded artifact files</li>
                        <li>Processed data in the database</li>
                        <li>Analysis history and logs</li>
                    </ul>
                    will be permanently deleted.
                </div>
                <div class="mb-3">
                    <label for="confirmCaseName" class="form-label">
                        Type the case name <strong>{{ case.case_name }}</strong> to confirm:
                    </label>
                    <input type="text" class="form-control" id="confirmCaseName" 
                           placeholder="Enter case name to confirm deletion">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled onclick="deleteCase()">
                    <i class="fas fa-trash me-1"></i>Delete Case
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Save Progress Modal -->
<div class="modal fade" id="saveProgressModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-save me-2"></i>Saving Changes
                </h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mb-0">Updating case information...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let deleteModal;

// Initialize modals
document.addEventListener('DOMContentLoaded', function() {
    deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    
    // Enable/disable delete confirmation button based on case name input
    document.getElementById('confirmCaseName').addEventListener('input', function() {
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const expectedName = '{{ case.case_name }}';
        confirmBtn.disabled = this.value !== expectedName;
    });
});

// Handle form submission
document.getElementById('editCaseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const saveModal = new bootstrap.Modal(document.getElementById('saveProgressModal'));
    
    // Show progress modal
    saveModal.show();
    
    // Convert FormData to JSON
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    // Submit form
    fetch('/cases/{{ case.case_uuid }}/edit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        saveModal.hide();
        
        if (data.success) {
            // Show success message
            showAlert('success', 'Case updated successfully!');
            
            // Redirect to case view after a short delay
            setTimeout(() => {
                window.location.href = `/cases/${data.case_id || '{{ case.case_uuid }}'}`;
            }, 1500);
        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        saveModal.hide();
        showAlert('danger', 'Error updating case: ' + error.message);
    });
});

// Show delete confirmation modal
function confirmDelete() {
    // Clear the confirmation input
    document.getElementById('confirmCaseName').value = '';
    document.getElementById('confirmDeleteBtn').disabled = true;
    
    deleteModal.show();
}

// Delete case
function deleteCase() {
    const confirmName = document.getElementById('confirmCaseName').value;
    const expectedName = '{{ case.case_name }}';
    
    if (confirmName !== expectedName) {
        showAlert('danger', 'Case name does not match. Please type the exact case name.');
        return;
    }
    
    deleteModal.hide();
    
    // Show loading state
    const saveModal = new bootstrap.Modal(document.getElementById('saveProgressModal'));
    saveModal.show();
    document.querySelector('#saveProgressModal .modal-title').innerHTML = 
        '<i class="fas fa-trash me-2"></i>Deleting Case';
    document.querySelector('#saveProgressModal .modal-body p').textContent = 
        'Deleting case and all associated data...';
    
    fetch('/cases/{{ case.case_uuid }}', {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        saveModal.hide();
        
        if (data.success) {
            showAlert('success', 'Case deleted successfully!');
            
            setTimeout(() => {
                window.location.href = '/cases';
            }, 1500);
        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        saveModal.hide();
        showAlert('danger', 'Error deleting case: ' + error.message);
    });
}

// Show alert message
function showAlert(type, message) {
    const alertContainer = document.createElement('div');
    alertContainer.className = `alert alert-${type} alert-dismissible fade show`;
    alertContainer.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the card body
    const cardBody = document.querySelector('.card-body');
    cardBody.insertBefore(alertContainer, cardBody.firstChild);
    
    // Auto-hide success alerts
    if (type === 'success') {
        setTimeout(() => {
            if (alertContainer.parentNode) {
                alertContainer.remove();
            }
        }, 5000);
    }
}

// Form validation
document.getElementById('case_name').addEventListener('input', function() {
    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = this.value.trim().length === 0;
});

// Warn about unsaved changes
let formChanged = false;
const formInputs = document.querySelectorAll('#editCaseForm input, #editCaseForm textarea, #editCaseForm select');

formInputs.forEach(input => {
    input.addEventListener('change', () => {
        formChanged = true;
    });
});

window.addEventListener('beforeunload', function(e) {
    if (formChanged) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
    }
});

// Reset form changed flag on successful submission
document.getElementById('editCaseForm').addEventListener('submit', function() {
    formChanged = false;
});
</script>
{% endblock %}